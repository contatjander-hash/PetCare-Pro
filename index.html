 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/index.html b/index.html
index 810ec592f0aa4e9311e32aa65e50ba8d52fb2c28..74f44e5f5e76c4dc681dd75ff061490bf84640b1 100644
--- a/index.html
+++ b/index.html
@@ -3105,61 +3105,63 @@ function requireField(value, message, elToFocus) {
 let petData = {
   name: '',
   species: '',
   breed: '',
   birth_date: '',
   photo: '',
   vaccines: [],
   medicines: [],
   weights: []
 };
 
 let petsList = [];        // lista de pets do usuário logado
 let currentPetId = null;  // pet atualmente aberto
 
 // -------------------------
 // Supabase (dados multi-dispositivo)
 // OBS: o supabaseClient é definido mais abaixo no HTML.
 // Estas funções só rodam quando o usuário já está logado.
 // -------------------------
 async function loadData() {
   if (typeof supabaseClient === 'undefined') return;
   if (window._loadingData) return; // evita chamadas simultâneas
   window._loadingData = true;
   try {
 
-  // getSession é síncrono com o storage local — mais confiável no reload
-  // do que getUser() que faz round-trip ao servidor
+  // getSession lê do storage local (mais rápido no reload)
   let user = null;
   try {
     const { data: sessionData } = await supabaseClient.auth.getSession();
     user = sessionData?.session?.user || null;
 
-    // Se getSession não retornou user, tenta getUser como fallback
+    // fallback para getUser, mas com timeout para evitar travas
     if (!user) {
-      const { data: userData } = await supabaseClient.auth.getUser();
-      user = userData?.user || null;
+      const userResp = await Promise.race([
+        supabaseClient.auth.getUser(),
+        new Promise((_, reject) => setTimeout(() => reject(new Error('getUser timeout')), 4000))
+      ]);
+      user = userResp?.data?.user || null;
     }
   } catch (err) {
     console.error('loadData: erro ao buscar sessão:', err);
   }
 
   if (!user) {
     petsList = [];
     currentPetId = null;
     petData = { name:'', species:'', breed:'', birth_date:'', photo:'', vaccines:[], medicines:[], weights:[] };
     updatePetProfile();
     renderVaccines();
     renderMedicines();
     renderWeights();
     return;
   }
 
   const { data: pets, error: petsError } = await supabaseClient
     .from('pets')
     .select('id, name, species, breed, birth_date, photo_url, created_at')
     .eq('user_id', user.id)
     .order('created_at', { ascending: true });
 
   if (petsError) {
     console.error("Erro ao buscar pets:", petsError);
     return;
@@ -3207,79 +3209,81 @@ async function loadData() {
   if (weiRes.error) console.error("Erro weights:", weiRes.error);
 
   const pet = petsList.find(p => p.id === currentPetId);
 
   petData = {
     name: pet?.name || '',
     species: pet?.species || '',
     breed: pet?.breed || '',
     birth_date: pet?.birth_date || '',
     photo: pet?.photo_url || '',
     vaccines: (vaccRes.data || []).map(v => ({
       id: v.id,
       type: 'vaccine',
       name: v.name,
       date: v.applied_date,
       next_due_date: v.next_due_date || null
     })),
     medicines: medRes.data || [],
     weights: weiRes.data || []
   };
 
   updatePetProfile();
   renderVaccines();
   renderMedicines();
   renderWeights();
-  window._loadingData = false;
   } catch(err) {
     console.error('loadData erro:', err);
   } finally {
     window._loadingData = false;
   }
 }
 async function saveData() {
   // Garante que o Supabase está carregado
   if (typeof supabaseClient === 'undefined') {
     console.error('saveData: supabaseClient não disponível');
     return { ok: false };
   }
 
-  // Busca sessão com timeout de 5s para não travar
+  // Busca sessão primeiro pelo storage local e depois pelo servidor
   let user = null;
   try {
-    const sessionData = await Promise.race([
-      supabaseClient.auth.getUser(),
-      new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000))
-    ]);
-    user = sessionData?.data?.user || null;
+    const { data: sessionData } = await supabaseClient.auth.getSession();
+    user = sessionData?.session?.user || null;
+
+    if (!user) {
+      const userResp = await Promise.race([
+        supabaseClient.auth.getUser(),
+        new Promise((_, reject) => setTimeout(() => reject(new Error('getUser timeout')), 5000))
+      ]);
+      user = userResp?.data?.user || null;
+    }
   } catch (err) {
     console.error('saveData: erro ao buscar sessão:', err);
-    // Tenta via localStorage como fallback
+    // fallback somente para UI; sem sessão válida, a escrita pode falhar por RLS
     const localUser = JSON.parse(localStorage.getItem('petcare_user') || 'null');
-    if (localUser?.id) {
-      user = localUser;
-    }
+    if (localUser?.id) user = localUser;
   }
 
   if (!user) {
     showToast('⚠️ Sessão expirada. Faça login novamente.');
     openAuthModal('login');
     return { ok: false };
   }
 
   const payload = {
     user_id: user.id,
     name: petData.name,
     species: petData.species || null,
     breed: petData.breed || null,
     birth_date: petData.birth_date || null,
     photo_url: petData.photo || null
   };
 
   try {
     if (currentPetId) {
       const { error } = await supabaseClient
         .from('pets')
         .update(payload)
         .eq('id', currentPetId)
         .eq('user_id', user.id);
 
@@ -4351,50 +4355,66 @@ function syncLocalUserFromSupabase(user) {
 }
 
 supabaseClient.auth.onAuthStateChange(async (event, session) => {
   // Só age em eventos reais — evita loop com TOKEN_REFRESHED
   if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
     if (session?.user) {
       syncLocalUserFromSupabase(session.user);
       checkUserSession();
       loadUserProfile();
       await loadData();
     }
   } else if (event === 'SIGNED_OUT') {
     localStorage.removeItem('petcare_user');
     petsList = [];
     currentPetId = null;
     petData = { name:'', species:'', breed:'', birth_date:'', photo:'', vaccines:[], medicines:[], weights:[] };
     updatePetProfile();
     renderVaccines();
     renderMedicines();
     renderWeights();
     checkUserSession();
     loadUserProfile();
   }
 });
 
+(async function hydrateSessionOnReload() {
+  try {
+    const { data: sessionData } = await supabaseClient.auth.getSession();
+    const user = sessionData?.session?.user || null;
+
+    if (user) {
+      syncLocalUserFromSupabase(user);
+      checkUserSession();
+      loadUserProfile();
+      await loadData();
+    }
+  } catch (err) {
+    console.error('hydrateSessionOnReload erro:', err);
+  }
+})();
+
     async function loginWithGoogle() {
         const { error } = await supabaseClient.auth.signInWithOAuth({
             provider: "google",
             options: {
                 redirectTo: "https://petcarenew.vercel.app"
             }
         });
 
         if (error) {
             alert("Erro: " + error.message);
         }
     }
 
 
     // ✅ Login com Email/Senha (Supabase)
     async function handleLogin(e) {
         e.preventDefault();
 
         const email = document.getElementById('loginEmail')?.value?.trim();
         const password = document.getElementById('loginPassword')?.value;
 
         if (!email || !password) {
             alert("Preencha email e senha.");
             return;
         }
 
EOF
)
